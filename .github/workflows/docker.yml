name: Docker Backend
on:
  push:
    branches: [ main ]
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ğŸ”¨ Build JAR
      run: mvn clean package -DskipTests

    - name: ğŸ“¦ Send Build Success
      if: success()
      run: |
        curl -H "Content-Type: application/json" \
          -X POST \
          -d '{
            "embeds": [{
              "title": "âœ… Maven ë¹Œë“œ ì™„ë£Œ!",
              "description": "JAR íŒŒì¼ ìƒì„± ì™„ë£Œ\nğŸ“ ${{ github.repository }}",
              "color": 65280,
              "timestamp": "${{ github.event.created_at }}"
            }]
          }' \
          ${{ secrets.DISCORD_WEBHOOK_URL }}

    - name: ğŸ” Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ³ Build & Push Docker
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ghcr.io/${{ github.repository_owner }}/apiwiki-be-v1:latest

    - name: ğŸ‰ Send Deploy Success
      if: success()
      run: |
        curl -H "Content-Type: application/json" \
          -X POST \
          -d '{
            "embeds": [{
              "title": "ğŸš€ ë°±ì—”ë“œ ë°°í¬ ì™„ë£Œ!",
              "description": "ìƒˆ ì´ë¯¸ì§€ í‘¸ì‹œë¨\nğŸ·ï¸ ${{ github.repository }}:latest\nğŸ”„ Watchtower ìë™ ì—…ë°ì´íŠ¸ ì˜ˆì •",
              "color": 5763719,
              "fields": [{
                "name": "ì»¤ë°‹",
                "value": "`${{ github.sha }}`",
                "inline": true
              }],
              "timestamp": "${{ github.event.created_at }}"
            }]
          }' \
          ${{ secrets.DISCORD_WEBHOOK_URL }}

    - name: âŒ Send Failure Alert
      if: failure()
      run: |
        curl -H "Content-Type: application/json" \
          -X POST \
          -d '{
            "embeds": [{
              "title": "âŒ ë°±ì—”ë“œ ë¹Œë“œ ì‹¤íŒ¨!",
              "description": "**${{ github.repository }}**\në¹Œë“œ/í‘¸ì‹œ ì‹¤íŒ¨\nğŸ”§ ìˆ˜ë™ í™•ì¸ í•„ìš”",
              "color": 16711680,
              "fields": [{
                "name": "ì‹¤íŒ¨ ë‹¨ê³„",
                "value": "`${{ github.job }}/${{ github.status }}`",
                "inline": true
              }],
              "timestamp": "${{ github.event.created_at }}"
            }]
          }' \
          ${{ secrets.DISCORD_WEBHOOK_URL }}
